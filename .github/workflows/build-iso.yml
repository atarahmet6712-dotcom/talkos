name: TalkOS ISO Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-iso:
    name: Build TalkOS ISO
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -ex
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap squashfs-tools xorriso curl gnupg git gettext \
            cpio genisoimage syslinux syslinux-common isolinux \
            dosfstools mtools grub-pc-bin grub-efi-amd64-bin

      - name: Setup Debian archive keyring
        run: |
          set -ex
          # Ubuntu'nun keyring'i Debian Bookworm için yeterli olmayabilir
          # Debian'dan güncel keyring paketini indirip kuruyoruz
          curl -sL -o /tmp/debian-archive-keyring.deb \
            "http://deb.debian.org/debian/pool/main/d/debian-archive-keyring/debian-archive-keyring_2023.4_all.deb"
          sudo dpkg -i /tmp/debian-archive-keyring.deb || true
          sudo apt-get install -f -y

          # Doğrulama
          ls -la /usr/share/keyrings/debian-archive-keyring.gpg
          echo "✅ Keyring kuruldu"

      - name: Install latest live-build from Debian
        run: |
          set -ex
          sudo apt-get remove -y live-build 2>/dev/null || true
          git clone --depth=1 https://salsa.debian.org/live-team/live-build.git /tmp/live-build
          cd /tmp/live-build
          sudo make install
          echo "live-build version:"
          lb --version || echo "lb installed (no --version flag)"

      - name: Prepare auto scripts
        run: |
          set -ex
          chmod +x talkos-build/auto/*
          echo "Auto scripts:"
          ls -la talkos-build/auto/

      - name: Fix line endings
        run: |
          set -ex
          # Windows CRLF -> Unix LF dönüşümü (çok önemli!)
          sudo apt-get install -y dos2unix
          find talkos-build -type f \( -name "*.chroot" -o -name "*.binary" -o -name "*.sh" -o -path "*/auto/*" \) -exec dos2unix {} \;
          # auto scripts'lerin LF olduğundan emin ol
          dos2unix talkos-build/auto/config talkos-build/auto/build talkos-build/auto/clean
          echo "✅ Line endings fixed"

      - name: Run lb config
        working-directory: ${{ github.workspace }}/talkos-build
        run: |
          set -ex
          sudo lb clean --all 2>/dev/null || true
          sudo lb config
          echo "✅ lb config completed"
          echo "=== Generated config ==="
          cat .build/config || true
          ls -la config/ || true

      - name: Run lb build
        working-directory: ${{ github.workspace }}/talkos-build
        run: |
          set -ex
          sudo lb build 2>&1 | tee build.log
        timeout-minutes: 90

      - name: Debug - List build outputs
        if: always()
        working-directory: ${{ github.workspace }}/talkos-build
        run: |
          echo "=== Build directory contents ==="
          ls -la . || true
          echo "=== Looking for ISO files ==="
          find . -name "*.iso" -o -name "*.hybrid.iso" 2>/dev/null || true
          echo "=== Looking for any large files ==="
          find . -maxdepth 1 -size +1M -exec ls -lh {} \; 2>/dev/null || true
          echo "=== Build log tail ==="
          tail -200 build.log 2>/dev/null || echo "No build.log found"
          echo "=== Chroot log ==="
          tail -100 chroot.log 2>/dev/null || echo "No chroot.log found"

      - name: Find and rename ISO
        if: success()
        run: |
          set -ex
          # ISO talkos-build klasöründe olacak
          ISO=$(find talkos-build -maxdepth 1 -name "*.iso" 2>/dev/null | head -1)
          if [ -n "$ISO" ]; then
            sudo mv "$ISO" TalkOS-amd64-bookworm.iso
            ls -lh TalkOS-amd64-bookworm.iso
            echo "ISO_DONE=true" >> $GITHUB_ENV
          else
            echo "::error::ISO dosyası bulunamadı!"
            exit 1
          fi

      - name: Upload ISO as Artifact
        if: env.ISO_DONE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: TalkOS-ISO
          path: TalkOS-amd64-bookworm.iso
          retention-days: 7
          compression-level: 0

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            talkos-build/build.log
            talkos-build/chroot.log
          retention-days: 3