name: TalkOS ISO Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-iso:
    name: Build TalkOS ISO
    runs-on: ubuntu-22.04
    # live-build işlemleri yoğun CPU ve I/O gerektirir.
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          # 'live-build' paketini repodan kurmak yerine manuel kuracağız ama bağımlılıkları eksiksiz alalım
          sudo apt-get install -y -qq \
            debootstrap squashfs-tools xorriso curl gnupg git gettext \
            debian-archive-keyring debian-keyring cpio

      - name: Setup Debian archive keyring for Bookworm
        run: |
          # Ubuntu'nun debian-archive-keyring paketi Bookworm anahtarlarını içermeyebilir.
          # Debian'dan en güncel keyring paketini indirip kuruyoruz.
          KEYRING_URL="http://deb.debian.org/debian/pool/main/d/debian-archive-keyring/"
          # En güncel deb dosyasının adını bul
          KEYRING_DEB=$(curl -sL "$KEYRING_URL" | grep -oP 'debian-archive-keyring_[^"]+_all\.deb' | sort -V | tail -1)
          if [ -z "$KEYRING_DEB" ]; then
            echo "::warning::Could not find latest keyring, using fallback"
            KEYRING_DEB="debian-archive-keyring_2023.4_all.deb"
          fi
          echo "Downloading: ${KEYRING_URL}${KEYRING_DEB}"
          curl -sL -o /tmp/debian-archive-keyring.deb "${KEYRING_URL}${KEYRING_DEB}"
          sudo dpkg -i /tmp/debian-archive-keyring.deb || sudo apt-get install -f -y
          
          # Keyring dosyasının varlığını doğrula
          if [ ! -f /usr/share/keyrings/debian-archive-keyring.gpg ]; then
            echo "::error::debian-archive-keyring.gpg hala bulunamadı!"
            ls -la /usr/share/keyrings/ || true
            exit 1
          fi
          echo "✅ Debian archive keyring başarıyla kuruldu:"
          ls -la /usr/share/keyrings/debian-archive-keyring.gpg

      - name: Install latest live-build from Debian source
        run: |
          # Mevcut sürümü temizle ve en güncelini kur
          sudo apt-get remove -y live-build || true
          git clone --depth=1 https://salsa.debian.org/live-team/live-build.git /tmp/live-build
          cd /tmp/live-build
          sudo make install

      - name: Prepare auto scripts
        run: |
          # Scripts klasörünün varlığını kontrol et ve izinleri ver
          if [ -d "talkos-build/auto" ]; then
            chmod +x talkos-build/auto/*
          fi

      - name: Run lb config
        working-directory: ${{ github.workspace }}/talkos-build
        run: |
          # Ubuntu üzerinde Debian derlerken debootstrap'ın Debian anahtarlarına ihtiyacı olur
          # Ayrıca temiz bir başlangıç için 'lb clean' ekliyoruz
          sudo lb clean --all
          sudo lb config

      - name: Run lb build
        working-directory: ${{ github.workspace }}/talkos-build
        run: |
          # lb build komutu hata alsa bile logları görmek için 'always' yerine burada hata kontrolü yapıyoruz
          sudo lb build
        timeout-minutes: 90 # 60 dakika bazen yetmeyebilir, 90'a çıkardım

      - name: Find and rename ISO
        if: always()
        run: |
          # ISO dosyasını ararken talkos-build klasörünün içine bakıyoruz
          ISO=$(find talkos-build -maxdepth 1 -name "*.iso" 2>/dev/null | head -1)
          if [ -n "$ISO" ]; then
            sudo mv "$ISO" TalkOS-amd64-bookworm.iso
            echo "ISO_DONE=true" >> $GITHUB_ENV
          else
            echo "::error::ISO dosyası üretilemedi! Loglar kontrol ediliyor..."
            # Hata varsa son 100 satırı yazdır
            [ -f talkos-build/build.log ] && tail -n 100 talkos-build/build.log || true
            exit 1
          fi

      - name: Upload ISO as Artifact
        if: env.ISO_DONE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: TalkOS-ISO
          path: TalkOS-amd64-bookworm.iso
          retention-days: 7
          # Sıkıştırma yaparak yükleme hızını artırır
          compression-level: 0